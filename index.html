  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import { getDatabase, ref, push, onValue, update, remove } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAMtC5cYzHwgDK0bpt0sAQWiyITzcOBPXU",
        authDomain: "mango-message-a78a6.firebaseapp.com",
        projectId: "mango-message-a78a6",
        storageBucket: "mango-message-a78a6.firebasestorage.app",
        messagingSenderId: "71943097813",
        appId: "1:71943097813:web:192fd3e16e95362490415c",
        measurementId: "G-C0S7F0TZK7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("message-form");
        const messagesList = document.getElementById("messages");

        // Check if the user is blocked
        if (localStorage.getItem("isBlocked") === "true") {
            alert("You are blocked from posting messages.");
            form.remove(); // Remove the form to prevent interaction
            return;
        }

        form.addEventListener("submit", (e) => {
            e.preventDefault();
            const username = document.getElementById("username").value.trim();
            const message = document.getElementById("message").value.trim();
            const timestamp = new Date().toISOString();

            // Block the username "Liam"
            if (username.toLowerCase() === "liam") {
                alert("You are blocked from posting messages.");
                localStorage.setItem("isBlocked", "true");
                form.remove(); // Remove the form to prevent further interaction
                return;
            }

            // Validate the message length
            if (message.length > 75) {
                alert("Messages cannot exceed 75 characters.");
                return;
            }

            // Check for blocked words
            if (message.toLowerCase().includes("gay")) {
                alert("The word 'gay' is not allowed.");
                return;
            }

            if (username && message) {
                push(ref(db, "messages"), { username, message, timestamp, reports: 0 });
                form.reset();
            }
        });

        const messagesRef = ref(db, "messages");
        onValue(messagesRef, (snapshot) => {
            const messages = [];
            snapshot.forEach((childSnapshot) => {
                messages.push({ id: childSnapshot.key, ...childSnapshot.val() });
            });

            // Sort messages by timestamp (newest first)
            messages.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            // Clear and repopulate the list
            messagesList.innerHTML = "";
            messages.forEach(({ id, username, message, timestamp, reports }) => {
                const li = document.createElement("li");

                const usernameDiv = document.createElement("div");
                usernameDiv.className = "username";
                usernameDiv.textContent = username;

                const messageTextDiv = document.createElement("div");
                messageTextDiv.className = "message-text";
                messageTextDiv.textContent = message;

                const timestampDiv = document.createElement("div");
                timestampDiv.className = "timestamp";
                timestampDiv.textContent = new Date(timestamp).toLocaleString();

                const reportButton = document.createElement("button");
                reportButton.textContent = `Report (${reports || 0})`;
                reportButton.style.marginTop = "10px";
                reportButton.addEventListener("click", () => {
                    // Increment the report count
                    const messageRef = ref(db, `messages/${id}`);
                    update(messageRef, { reports: (reports || 0) + 1 });

                    // If the message has been reported 5 or more times, remove it
                    if ((reports || 0) + 1 >= 5) {
                        remove(messageRef);
                    }
                });

                li.appendChild(usernameDiv);
                li.appendChild(messageTextDiv);
                li.appendChild(timestampDiv);
                li.appendChild(reportButton);
                messagesList.appendChild(li);
            });
        });
    });
</script>
